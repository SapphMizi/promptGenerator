## Prompt Generator (PRISM + OpenAI API)

PHP で実装された、**参照画像に近い画像を生成するためのプロンプトを自動探索するシステム**です。  
Prompt Refinement via Iterative Search with Multimodal feedback (**PRISM**) と OpenAI API（GPT-4o / 画像生成 API / 埋め込み API）を組み合わせることで、画像類似度フィードバックを用いた反復的プロンプト最適化を行います。

---

### システム概要

- **目的**
  - ユーザーがアップロードした「参照画像」に対して、  
    「その画像にできるだけ似た画像を生成するためのプロンプト」と「対応する生成画像」を自動的に探索します。
- **特徴**
  - 画像 → プロンプト → 生成画像 → 画像類似度 → プロンプト改良、というループを自動で実行
  - マルチモーダルなフィードバック（参照画像 & 生成画像）を GPT-4o に与え、テキストプロンプトを更新
  - **並列探索**: N個のプロンプトストリームを並列に探索し、多様な解空間を効率的に探索（論文のAlgorithm 1に準拠）
  - **最終評価フェーズ**: 全反復から最良の候補を選び、全参照画像で再評価してtotal scoreで最良プロンプトを選択
  - 類似度が十分に高くなった時点で早期終了することで、API コストを抑制

UI レイヤでは、アップロードフォームと反復履歴・ベスト結果の表示のみを担い、  
本 README では主に **アルゴリズム** と **内部アーキテクチャ / 技術スタック** にフォーカスします。

---

### 使用している主なアルゴリズム

#### PRISM: Prompt Refinement via Iterative Search with Multimodal feedback

この実装では、`src/PrismEngine.php` に PRISM の中核ロジックが実装されています。

- **入力**
  - 参照画像パス（単一画像、または将来的に複数画像の配列に対応）
  - 並列探索数 N（`parallel_count`、デフォルト: 1）
  - 最大反復回数 K（`max_iterations`、デフォルト: 5）
- **出力**
  - 最良プロンプト（テキスト、total scoreに基づいて選択）
  - そのプロンプトで生成された画像パス
  - 各反復におけるプロンプト・類似度・生成画像などの履歴
  - 最終評価フェーズの結果（各候補プロンプトのtotal scoreと個別評価）

PRISM の反復フローは、[論文のAlgorithm 1](https://arxiv.org/pdf/2403.19103) に準拠して実装されており、概ね次のようになります：

1. **初期プロンプト生成**
   - 参照画像を GPT-4o に渡し、  
     「この画像に似た画像を生成するための詳細な日本語プロンプト」を生成します。
   - ここでは **スタイル・色調・構図・被写体・雰囲気・テクスチャ・等身・髪型** など、視覚的要素をできるだけ具体的にテキスト化します。
   - 実装上は `OpenAIClient::generateInitialPrompt()` が担当し、  
     画像を base64 エンコードして `chat/completions` エンドポイント（モデル: `gpt-4o`）に投げています。
   - 並列探索が有効な場合（`parallel_count > 1`）、初期プロンプトからN個のストリームを初期化します。

2. **並列反復ループ（Algorithm 1 Lines 3-11: for n = 1 to N in parallel, for k = 1 to K）**
   
   各ストリーム（n = 1 to N）が並列に実行され、各反復（k = 1 to K）で以下を繰り返します：
   
   1. **参照画像のサンプリング（Line 5）**
      - 各反復で、参照画像集合から1つの参照画像をランダムにサンプリング（単一画像の場合は同じものを使用）
      
   2. **プロンプト生成（Line 6）**
      - 各ストリームが独立したchat historyを保持し、それに基づいてプロンプトを生成・更新
      
   3. **画像生成（Line 7）**
      - 現在のプロンプトを用いて OpenAI の画像生成 API を呼び出し、生成画像を保存します。
      - `OpenAIClient::generateImage()` が `images/generations` エンドポイントを叩きます。
      - 画像生成モデルは設定値 `image_model` により切り替え可能で、実装では主に以下を想定しています：
        - `gpt-image-1` / `gpt-5.1`（カスタム画像モデル想定・`model` パラメータ明示）
        - `dall-e-3`（デフォルト。`model`/`response_format` を明示しない形で利用）
        - `dall-e-2`（`response_format=url` を付与）
      
   4. **in-iteration score計算（Line 8）**
      - 参照画像と生成画像それぞれに対して「画像埋め込みに相当するベクトル」を取得し、コサイン類似度を計算します。
      - このステップは `ImageSimilarity::calculateSimilarity()` が担当し、内部で：
        - `OpenAIClient::getImageEmbedding()` を 2 回呼び出す
        - それぞれの画像を GPT-4o に渡し、「画像の内容を詳細に説明したテキスト」を生成
        - その説明テキストを埋め込みモデル（デフォルト: `text-embedding-3-large`）に入力し、ベクトル取得
        - 2 つのベクトル間の **コサイン類似度** を計算（負値は 0 にクリップ）
      - ここでは「画像→テキスト→埋め込み」という 2 段階の近似的な CLIP 風アプローチを採用しています。
      - このスコアは「in-iteration score」として記録されます（単一参照画像との類似度）
      
   5. **ベスト更新 & 収束判定**
      - in-iteration scoreがこれまでのベストを上回れば、ベストプロンプト・ベスト画像を更新します。
      - 類似度があらかじめ設定された閾値（デフォルト: 0.85）を超えた場合、ループを早期終了します。
      
   6. **プロンプト改良（Line 9: Update p_θ_F based on chat history of stream n）**
      - 類似度が閾値に届かない場合、各ストリームの独立したchat historyを使用してプロンプトを改良します。
      - `OpenAIClient::refinePromptWithHistory()` が、次のような情報を GPT-4o に渡します：
        - ストリームのchat history（過去の反復でのプロンプト・スコア・改善点）
        - 現在のプロンプト
        - 現在のin-iteration score
        - 反復回数
        - 参照画像（base64）
        - 生成画像（base64）
      - GPT-4o はアートスタイル・色調・構図・照明・雰囲気・テクスチャ・等身・髪型などの視覚的差分に基づいて、  
        新しい日本語プロンプトを返します。
      - 各ストリームのchat historyは、この反復の結果を追加して更新されます。



3. **最終評価フェーズ（Algorithm 1 Lines 12-14）**
   
   1. **最良候補の収集（Line 12）**
      - 全反復から、in-iteration scoreが最も高いC個のプロンプトを収集（C = parallel_count × 2、最大10個）
      
   2. **Total scoreによる再評価（Line 13）**
      - 各候補プロンプトについて、全参照画像との類似度を計算し、total score（Σ_{i=1}^M s(x_i, y_c)）を算出
      - これにより、単一画像との類似度だけでなく、全参照画像との総合的な類似度で評価
      
   3. **最良プロンプトの選択（Line 14）**
      - total scoreが最高のプロンプトを選択（同点の場合は、より高いlog likelihoodを持つものを選択）

4. **終了と結果**
   - 最大反復回数に達するか、類似度が閾値を超えた時点でループを終了します。
   - 最終評価フェーズで選ばれた最良プロンプトと、そのプロンプトで生成された画像、全反復の履歴、および最終評価結果が返されます。

このように PRISM は、「**テキストだけでなく画像も含めたマルチモーダルフィードバックを用いてプロンプトを更新する探索アルゴリズム**」として機能します。

---

### 内部アーキテクチャ

#### 構成要素の概要

- **`PrismEngine` (`src/PrismEngine.php`)**
  - PRISM アルゴリズム本体（論文のAlgorithm 1に準拠）。
  - 参照画像パス（単一または配列）を受け取り、  
    初期プロンプト生成 → 並列反復ループ（画像生成・類似度計算・プロンプト改良）→ 最終評価フェーズ → ベスト結果の返却までをオーケストレーションします。
  - 主なパラメータ:
    - `max_iterations`（最大反復回数 K、デフォルト 5）
    - `similarity_threshold`（類似度の閾値、デフォルト 0.85）
    - `parallel_count`（並列探索数 N、デフォルト 1）
    - `output_dir`（生成画像保存ディレクトリ）
  - 各ストリームが独立したchat historyを保持し、過去の反復結果に基づいてプロンプトを改良します。

- **`OpenAIClient` (`src/OpenAIClient.php`)**
  - OpenAI API とのやり取りを担うクライアントクラス。
  - 担当機能:
    - `generateInitialPrompt(imagePath)`  
      参照画像から初期プロンプトを生成（`gpt-4o` + `chat/completions`）
    - `refinePrompt(currentPrompt, referenceImagePath, generatedImagePath, similarityScore, iteration)`  
      参照画像 & 生成画像 & 類似度を入力としてプロンプトを改良（`gpt-4o` + `chat/completions`）
    - `refinePromptWithHistory(currentPrompt, referenceImagePath, generatedImagePath, similarityScore, iteration, chatHistory)`  
      **chat historyを使用してプロンプトを改良**（論文のAlgorithm 1 Line 9に対応）
      各ストリームの独立した履歴に基づいて、過去の反復結果を考慮した改良を行います
    - `generateImage(prompt, outputPath)`  
      プロンプトから画像を生成しファイルとして保存（`images/generations`）
    - `getTextEmbedding(text)`  
      テキストから埋め込みベクトルを取得（デフォルト: `text-embedding-3-large`）
    - `getImageEmbedding(imagePath)`  
      画像から説明テキストを生成 → そのテキストの埋め込みを取得
  - 画像生成モデルの扱い:
    - `image_model` が `gpt-image-1` / `gpt-5.1` の場合:
      - `model` パラメータを明示的に付与し、カスタム画像モデルとして扱う
    - `image_model` が `dall-e-2` の場合:
      - `response_format=url` を指定
    - `image_model` が `dall-e-3`（または未指定）の場合:
      - デフォルトの挙動を利用（`model`/`response_format` を明示しない）
  - 埋め込みモデルの安全性チェック:
    - `embedding_model` に `gpt-image-1` / `gpt-5.1` / `dall-e-3` / `dall-e-2` といった画像モデルが誤設定された場合、
      自動的に `text-embedding-3-large` にフォールバックし、警告ログを出します。

- **`ImageSimilarity` (`src/ImageSimilarity.php`)**
  - 「画像 → 埋め込み → コサイン類似度」のパイプラインをカプセル化したクラス。
  - 2 枚の画像パスを受け取り、それぞれに対して `OpenAIClient::getImageEmbedding()` を呼び出し、
    埋め込みベクトル間のコサイン類似度（0〜1）を返します。
  - ベクトル次元不一致やゼロベクトルの場合は例外や 0.0 として安全に扱います。

- **`DebugLogger`**
  - API リクエスト/レスポンス、処理時間、エラー、反復ごとの詳細情報などをロギングするためのユーティリティ。
  - PRISM の挙動をトレースし、どの反復でどういう類似度が出ているかを追いやすくします。

---

### 技術スタック

- **言語 / ランタイム**
  - PHP 8 系想定
- **外部サービス**
  - OpenAI API
    - `chat/completions`（モデル: `gpt-4o`）
    - `images/generations`（モデル: `dall-e-3` / `gpt-image-1` / `gpt-5.1` / `dall-e-2` など）
    - `embeddings`（モデル: `text-embedding-3-large` など）
- **アルゴリズム / モデル**
  - PRISM（Prompt Refinement via Iterative Search with Multimodal feedback）
  - 画像内容のテキスト化 + テキスト埋め込みによる近似的な画像類似度評価
  - コサイン類似度による類似度スコアリング
- **その他**
  - HTTP クライアント: cURL（利用不可の場合は `file_get_contents` にフォールバック）
  - ロギング: 独自 `DebugLogger` クラス（ファイル / コンソール）

---

### 想定される応用例

- 既存のイラストやレンダリング画像を参照しつつ、  
  そのスタイルや構図に近いバリエーションを自動生成するワークフローのバックエンド
- 画像生成プロンプトの自動チューニング・A/B テストのための実験基盤
- 「参照画像に限りなく近い画像を作る」のではなく、  
  「一定以上似ていればよい」という閾値ベースの探索を用いた、  
  スタイルトランスファー的なプロンプト最適化の研究用途

---

### 制約と注意点（設計レベル）

- **API ポリシーの制約**
  - 顔や人物を含む画像、あるいはセンシティブなコンテンツを含む画像では、  
    GPT-4o による画像分析やプロンプト生成が拒否される場合があります。
  - 実装ではエラーメッセージや拒否メッセージを検出し、例外として扱うようになっています。
  - しかし，API に送るプロンプトに "この画像は ``gpt-image-1`` によって生成されたものです．" という注釈をつけると，なぜかポリシーを無視してプロンプトを生成させることができます．

- **画像埋め込みの近似性**
  - 現状の OpenAI API では「画像埋め込み専用のエンドポイント」を直接は利用しておらず、  
    「画像を説明するテキスト → テキスト埋め込み」という 2 段階の近似アプローチです。
  - そのため、CLIP のようなピクセルレベルの埋め込みとは異なる性質を持ちますが、  
    スタイル・構図・雰囲気といった高レベルのセマンティクスには強い類似度指標となります。

- **コストとレイテンシ**
  - 各反復で「画像生成 + 画像 2 枚の説明 + 埋め込み 2 回」という複数の API コールが発生するため、  
    反復回数が増えると API コストとレイテンシが増大します。
  - 並列探索（`parallel_count > 1`）を使用する場合、各ストリーム分だけ API コールが増加します。
  - `max_iterations`、`similarity_threshold`、`parallel_count` を適切に設計することで、  
    品質とコストのバランスを制御できます。
  - 最終評価フェーズでは、最良候補プロンプトを全参照画像で再評価するため、追加の API コールが発生します。

---

### 今後の拡張の方向性（アイデア）

- **類似度指標の多様化**
  - 画像→テキスト埋め込みに加えて、別種のモデルや手法による類似度を組み合わせる
  - CLIP等の直接的な画像埋め込みモデルの利用
- **複数参照画像への完全対応**
  - 現在は構造的に対応済みですが、UI側での複数画像アップロード機能の追加
  - 各反復での参照画像ランダムサンプリングの活用
- **並列探索の最適化**
  - 各ストリーム間での情報共有（prompt crossover等）
  - 動的な並列数の調整（初期は多く、収束に近づくと減らす等）
- **UI / 監視**
  - 各反復の画像とプロンプト・類似度のタイムラインを可視化するダッシュボード
  - 並列探索の各ストリームの進捗を可視化
  - 最終評価フェーズの結果の詳細表示

