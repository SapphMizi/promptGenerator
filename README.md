## Prompt Generator (PRISM + OpenAI API)

PHP で実装された、**参照画像に近い画像を生成するためのプロンプトを自動探索するシステム**です。  
Prompt Refinement via Iterative Search with Multimodal feedback (**PRISM**) と OpenAI API（GPT-4o / 画像生成 API / 埋め込み API）を組み合わせることで、画像類似度フィードバックを用いた反復的プロンプト最適化を行います。

---

### システム概要

- **目的**
  - ユーザーがアップロードした「参照画像」に対して、  
    「その画像にできるだけ似た画像を生成するためのプロンプト」と「対応する生成画像」を自動的に探索します。
- **特徴**
  - 画像 → プロンプト → 生成画像 → 画像類似度 → プロンプト改良、というループを自動で実行
  - マルチモーダルなフィードバック（参照画像 & 生成画像）を GPT-4o に与え、テキストプロンプトを更新
  - 類似度が十分に高くなった時点で早期終了することで、API コストを抑制

UI レイヤでは、アップロードフォームと反復履歴・ベスト結果の表示のみを担い、  
本 README では主に **アルゴリズム** と **内部アーキテクチャ / 技術スタック** にフォーカスします。

---

### 使用している主なアルゴリズム

#### PRISM: Prompt Refinement via Iterative Search with Multimodal feedback

この実装では、`src/PrismEngine.php` に PRISM の中核ロジックが実装されています。

- **入力**
  - 参照画像パス
- **出力**
  - 最良プロンプト（テキスト）
  - そのプロンプトで生成された画像パス
  - 各反復におけるプロンプト・類似度・生成画像などの履歴

PRISM の反復フローは概ね次のようになります：

1. **初期プロンプト生成**
   - 参照画像を GPT-4o に渡し、  
     「この画像に似た画像を生成するための詳細な日本語プロンプト」を生成します。
   - ここでは **スタイル・色調・構図・被写体・雰囲気・テクスチャ・等身・髪型** など、視覚的要素をできるだけ具体的にテキスト化します。
   - 実装上は `OpenAIClient::generateInitialPrompt()` が担当し、  
     画像を base64 エンコードして `chat/completions` エンドポイント（モデル: `gpt-4o`）に投げています。

2. **反復ループ**
   1. **画像生成**
      - 現在のプロンプトを用いて OpenAI の画像生成 API を呼び出し、生成画像を保存します。
      - `OpenAIClient::generateImage()` が `images/generations` エンドポイントを叩きます。
      - 画像生成モデルは設定値 `image_model` により切り替え可能で、実装では主に以下を想定しています：
        - `gpt-image-1` / `gpt-5.1`（カスタム画像モデル想定・`model` パラメータ明示）
        - `dall-e-3`（デフォルト。`model`/`response_format` を明示しない形で利用）
        - `dall-e-2`（`response_format=url` を付与）
   2. **画像類似度評価**
      - 参照画像と生成画像それぞれに対して「画像埋め込みに相当するベクトル」を取得し、コサイン類似度を計算します。
      - このステップは `ImageSimilarity::calculateSimilarity()` が担当し、内部で：
        - `OpenAIClient::getImageEmbedding()` を 2 回呼び出す
        - それぞれの画像を GPT-4o に渡し、「画像の内容を詳細に説明したテキスト」を生成
        - その説明テキストを埋め込みモデル（デフォルト: `text-embedding-3-large`）に入力し、ベクトル取得
        - 2 つのベクトル間の **コサイン類似度** を計算（負値は 0 にクリップ）
      - ここでは「画像→テキスト→埋め込み」という 2 段階の近似的な CLIP 風アプローチを採用しています。
   3. **ベスト更新 & 収束判定**
      - 類似度がこれまでのベストを上回れば、ベストプロンプト・ベスト画像を更新します。
      - 類似度があらかじめ設定された閾値（デフォルト: 0.85）を超えた場合、ループを早期終了します。
   4. **プロンプト改良**
      - 類似度が閾値に届かない場合、参照画像と直近の生成画像、現在のプロンプト、類似度スコアを GPT-4o に提示し、  
        「どう修正すると参照画像に近づくか」をマルチモーダルに評価させます。
      - `OpenAIClient::refinePrompt()` が、次のような情報を GPT-4o に渡します：
        - 現在のプロンプト
        - 現在の類似度スコア
        - 反復回数
        - 参照画像（base64）
        - 生成画像（base64）
      - GPT-4o はアートスタイル・色調・構図・照明・雰囲気・テクスチャ・等身・髪型などの視覚的差分に基づいて、  
        新しい日本語プロンプトを 1 本だけ返します。

3. **終了と結果**
   - 最大反復回数に達するか、類似度が閾値を超えた時点でループを終了します。
   - 最良の類似度スコアを持つプロンプトと、そのプロンプトで生成された画像、および全反復の履歴が結果として返されます。

このように PRISM は、「**テキストだけでなく画像も含めたマルチモーダルフィードバックを用いてプロンプトを更新する探索アルゴリズム**」として機能します。

---

### 内部アーキテクチャ

#### 構成要素の概要

- **`PrismEngine` (`src/PrismEngine.php`)**
  - PRISM アルゴリズム本体。
  - 参照画像パスを受け取り、  
    初期プロンプト生成 → 反復ループ（画像生成・類似度計算・プロンプト改良）→ ベスト結果の返却までをオーケストレーションします。
  - 主なパラメータ:
    - `max_iterations`（最大反復回数、デフォルト 5）
    - `similarity_threshold`（類似度の閾値、デフォルト 0.85）
    - `output_dir`（生成画像保存ディレクトリ）

- **`OpenAIClient` (`src/OpenAIClient.php`)**
  - OpenAI API とのやり取りを担うクライアントクラス。
  - 担当機能:
    - `generateInitialPrompt(imagePath)`  
      参照画像から初期プロンプトを生成（`gpt-4o` + `chat/completions`）
    - `refinePrompt(currentPrompt, referenceImagePath, generatedImagePath, similarityScore, iteration)`  
      参照画像 & 生成画像 & 類似度を入力としてプロンプトを改良（`gpt-4o` + `chat/completions`）
    - `generateImage(prompt, outputPath)`  
      プロンプトから画像を生成しファイルとして保存（`images/generations`）
    - `getTextEmbedding(text)`  
      テキストから埋め込みベクトルを取得（デフォルト: `text-embedding-3-large`）
    - `getImageEmbedding(imagePath)`  
      画像から説明テキストを生成 → そのテキストの埋め込みを取得
  - 画像生成モデルの扱い:
    - `image_model` が `gpt-image-1` / `gpt-5.1` の場合:
      - `model` パラメータを明示的に付与し、カスタム画像モデルとして扱う
    - `image_model` が `dall-e-2` の場合:
      - `response_format=url` を指定
    - `image_model` が `dall-e-3`（または未指定）の場合:
      - デフォルトの挙動を利用（`model`/`response_format` を明示しない）
  - 埋め込みモデルの安全性チェック:
    - `embedding_model` に `gpt-image-1` / `gpt-5.1` / `dall-e-3` / `dall-e-2` といった画像モデルが誤設定された場合、
      自動的に `text-embedding-3-large` にフォールバックし、警告ログを出します。

- **`ImageSimilarity` (`src/ImageSimilarity.php`)**
  - 「画像 → 埋め込み → コサイン類似度」のパイプラインをカプセル化したクラス。
  - 2 枚の画像パスを受け取り、それぞれに対して `OpenAIClient::getImageEmbedding()` を呼び出し、
    埋め込みベクトル間のコサイン類似度（0〜1）を返します。
  - ベクトル次元不一致やゼロベクトルの場合は例外や 0.0 として安全に扱います。

- **`DebugLogger`**
  - API リクエスト/レスポンス、処理時間、エラー、反復ごとの詳細情報などをロギングするためのユーティリティ。
  - PRISM の挙動をトレースし、どの反復でどういう類似度が出ているかを追いやすくします。

---

### 技術スタック

- **言語 / ランタイム**
  - PHP 8 系想定
- **外部サービス**
  - OpenAI API
    - `chat/completions`（モデル: `gpt-4o`）
    - `images/generations`（モデル: `dall-e-3` / `gpt-image-1` / `gpt-5.1` / `dall-e-2` など）
    - `embeddings`（モデル: `text-embedding-3-large` など）
- **アルゴリズム / モデル**
  - PRISM（Prompt Refinement via Iterative Search with Multimodal feedback）
  - 画像内容のテキスト化 + テキスト埋め込みによる近似的な画像類似度評価
  - コサイン類似度による類似度スコアリング
- **その他**
  - HTTP クライアント: cURL（利用不可の場合は `file_get_contents` にフォールバック）
  - ロギング: 独自 `DebugLogger` クラス（ファイル / コンソール）

---

### 想定される応用例

- 既存のイラストやレンダリング画像を参照しつつ、  
  そのスタイルや構図に近いバリエーションを自動生成するワークフローのバックエンド
- 画像生成プロンプトの自動チューニング・A/B テストのための実験基盤
- 「参照画像に限りなく近い画像を作る」のではなく、  
  「一定以上似ていればよい」という閾値ベースの探索を用いた、  
  スタイルトランスファー的なプロンプト最適化の研究用途

---

### 制約と注意点（設計レベル）

- **API ポリシーの制約**
  - 顔や人物を含む画像、あるいはセンシティブなコンテンツを含む画像では、  
    GPT-4o による画像分析やプロンプト生成が拒否される場合があります。
  - 実装ではエラーメッセージや拒否メッセージを検出し、例外として扱うようになっています。

- **画像埋め込みの近似性**
  - 現状の OpenAI API では「画像埋め込み専用のエンドポイント」を直接は利用しておらず、  
    「画像を説明するテキスト → テキスト埋め込み」という 2 段階の近似アプローチです。
  - そのため、CLIP のようなピクセルレベルの埋め込みとは異なる性質を持ちますが、  
    スタイル・構図・雰囲気といった高レベルのセマンティクスには強い類似度指標となります。

- **コストとレイテンシ**
  - 各反復で「画像生成 + 画像 2 枚の説明 + 埋め込み 2 回」という複数の API コールが発生するため、  
    反復回数が増えると API コストとレイテンシが増大します。
  - `max_iterations` と `similarity_threshold` を適切に設計することで、  
    品質とコストのバランスを制御できます。

---

### 今後の拡張の方向性（アイデア）

- 類似度指標の多様化
  - 画像→テキスト埋め込みに加えて、別種のモデルや手法による類似度を組み合わせる
- 探索戦略の拡張
  - 1 本のプロンプトを逐次改善するのではなく、  
    複数プロンプトを並列に維持しつつ探索するビームサーチ的アプローチ
- UI / 監視
  - 各反復の画像とプロンプト・類似度のタイムラインを可視化するダッシュボード

